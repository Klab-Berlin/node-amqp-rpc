<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="Node-amqp-rpc : AMQP RPC driver for node. Tested on RabbitMQ." />

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>Node-amqp-rpc</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/demchenkoe/node-amqp-rpc">View on GitHub</a>

          <h1 id="project_title">Node-amqp-rpc</h1>
          <h2 id="project_tagline">AMQP RPC driver for node. Tested on the real highload projects.</h2>
          <form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top">
            <input type="hidden" name="cmd" value="_s-xclick">
            <input type="hidden" name="hosted_button_id" value="D9KJCGW262DWC">
            <input type="image" src="https://www.paypalobjects.com/en_US/GB/i/btn/btn_donateCC_LG.gif" border="0" name="submit" alt="PayPal â€“ The safer, easier way to pay online.">
            <img alt="" border="0" src="https://www.paypalobjects.com/ru_RU/i/scr/pixel.gif" width="1" height="1">
          </form>



            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/demchenkoe/node-amqp-rpc/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/demchenkoe/node-amqp-rpc/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <h1>
<a name="amqp-rpc" class="anchor" href="#amqp-rpc"><span class="octicon octicon-link"></span></a>AMQP-RPC</h1>

<p>RPC library based on AMQP protocol.
Tested with RabbitMQ on the highload project.</p>

<h3>
<a name="install-rabitmq" class="anchor" href="#install-rabitmq"><span class="octicon octicon-link"></span></a>Install RabitMQ</h3>

<pre><code>apt-get install rabbitmq-server
</code></pre>

<h3>
<a name="install-library" class="anchor" href="#install-library"><span class="octicon octicon-link"></span></a>Install library</h3>

<pre><code>npm install amqp-rpc
</code></pre>

<h2>
<a name="round-robin" class="anchor" href="#round-robin"><span class="octicon octicon-link"></span></a>round-robin</h2>

<p>Example: Call remote function.
Run multiple servers.js for round-robin shared.</p>

<h3>
<a name="serverjs-example" class="anchor" href="#serverjs-example"><span class="octicon octicon-link"></span></a>server.js example</h3>

<pre><code>var rpc = require('amqp-rpc').factory({
    url: "amqp://guest:guest@localhost:5672"
});


rpc.on('inc', function(param, cb){
    var prevVal = param;
    var nextVal = param+2;
    cb(++param, prevVal, nextVal);
});

rpc.on('say.*', function(param, cb, inf){

    var arr = inf.cmd.split('.');

    var name = (param &amp;&amp; param.name) ? param.name : 'world';

    cb(arr[1] + ' ' + name + '!');

});

rpc.on('withoutCB', function(param, cb, inf) {

  if(cb){
    cb('please run function without cb parameter')
  }
  else{
    console.log('this is function withoutCB');
  }

});
</code></pre>

<h3>
<a name="clientjs-example" class="anchor" href="#clientjs-example"><span class="octicon octicon-link"></span></a>client.js example</h3>

<pre><code>var rpc = require('amqp-rpc').factory({
    url: "amqp://guest:guest@localhost:5672"
});

rpc.call('inc', 5, function() {
    console.log('results of inc:', arguments);  //output: [6,4,7]
});

rpc.call('say.Hello', { name: 'John' }, function(msg) {
    console.log('results of say.Hello:', msg);  //output: Hello John!
});

rpc.call('withoutCB', {}, function(msg) {
    console.log('withoutCB results:', msg);  //output: please run function without cb parameter
});

rpc.call('withoutCB', {}); //output message on server side console
</code></pre>

<h2>
<a name="broadcast" class="anchor" href="#broadcast"><span class="octicon octicon-link"></span></a>broadcast</h2>

<p>Example: Core receiving data from all workers.
Run multiple worker.js for broadcast witness.
The core.js must be launched after all worker.js instances.</p>

<h3>
<a name="examplebroadcastworkerjs" class="anchor" href="#examplebroadcastworkerjs"><span class="octicon octicon-link"></span></a>example/broadcast/worker.js</h3>

<pre><code>var os = require('os');
var worker_name = os.hostname() + ':' + process.pid;
var counter = 0;

var rpc = require('../../index').factory({
    url: "amqp://guest:guest@localhost:5672"
});

rpc.onBroadcast('getWorkerStat', function(params, cb)    {
    if(params &amp;&amp; params.type == 'fullStat') {
        cb(null, {
            pid: process.pid,
            hostname: os.hostname(),
            uptime: process.uptime(),
            counter: counter++
        });
    }
    else {
        cb(null, { counter: counter++ })
    }
});
</code></pre>

<h3>
<a name="examplebroadcastcorejs" class="anchor" href="#examplebroadcastcorejs"><span class="octicon octicon-link"></span></a>example/broadcast/core.js</h3>

<pre><code>var rpc = require('../../index').factory({
    url: "amqp://guest:guest@localhost:5672"
});

var all_stats = {};

//rpc.callBroadcast() is rpc.call() + waiting multiple responses
//If remote handler without response data, you can use rpc.call() for initiate broadcast calls.

rpc.callBroadcast(
    'getWorkerStat',
    { type: 'fullStat'},                    //request parameters
    {                                       //call options
        ttl: 1000,                          //wait response time  (1 seconds), after run onComplete
        onResponse: function(err, stat)  {  //callback on each worker response
            all_stats[ stat.hostname+':'+ stat.pid ] = stat;

        },
        onComplete: function()  {   //callback on ttl expired
            console.log('----------------------- WORKER STATISTICS ----------------------------------------');
            for(var worker in all_stats) {
                s = all_stats[worker];
                console.log(worker, '\tuptime=', s.uptime.toFixed(2) + ' seconds', '\tcounter=', s.counter);
            }
        }
    });
</code></pre>

<p>Results for three workers:</p>

<pre><code>----------------------- WORKER STATISTICS ----------------------------------------
host1:2612  uptime= 2470.39 seconds     counter= 2
host2:1615  uptime= 3723.53 seconds     counter= 8
host2:2822  uptime= 2279.16 seconds     counter= 3
</code></pre>

<p>Eugene Demchenko aka Goldy skype demchenkoe email <a href="mailto:demchenkoev@gmail.com">demchenkoev@gmail.com</a></p>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Node-amqp-rpc maintained by <a href="https://github.com/demchenkoe">demchenkoe</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    

  </body>
</html>
